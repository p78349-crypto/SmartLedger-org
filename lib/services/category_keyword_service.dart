// ignore_for_file: lines_longer_than_80_chars

/// Offline keyword-based category classifier for expense transactions.
///
/// Provides fallback classification when user history hints are unavailable.
/// Uses a curated dictionary of Korean product keywords mapped to categories.
class CategoryKeywordService {
  CategoryKeywordService._();
  static final CategoryKeywordService instance = CategoryKeywordService._();

  /// Primary keyword → category mapping.
  /// Key: normalized keyword (lowercase, no spaces).
  /// Value: (mainCategory, subCategory?).
  static const Map<String, (String, String?)> _keywordToCategory = {
    // ─────────────────────────────────────────────────────────────
    // 식비 > 식자재 구매
    // ─────────────────────────────────────────────────────────────
    '우유': ('식비', '식자재 구매'),
    '서울우유': ('식비', '식자재 구매'),
    '매일우유': ('식비', '식자재 구매'),
    '남양우유': ('식비', '식자재 구매'),
    '두유': ('식비', '식자재 구매'),
    '요거트': ('식비', '식자재 구매'),
    '요플레': ('식비', '식자재 구매'),
    '치즈': ('식비', '식자재 구매'),
    '버터': ('식비', '식자재 구매'),
    '계란': ('식비', '식자재 구매'),
    '달걀': ('식비', '식자재 구매'),
    '쌀': ('식비', '식자재 구매'),
    '백미': ('식비', '식자재 구매'),
    '현미': ('식비', '식자재 구매'),
    '찹쌀': ('식비', '식자재 구매'),
    '밀가루': ('식비', '식자재 구매'),
    '식용유': ('식비', '식자재 구매'),
    '올리브유': ('식비', '식자재 구매'),
    '참기름': ('식비', '식자재 구매'),
    '들기름': ('식비', '식자재 구매'),
    '간장': ('식비', '식자재 구매'),
    '된장': ('식비', '식자재 구매'),
    '고추장': ('식비', '식자재 구매'),
    '쌈장': ('식비', '식자재 구매'),
    '소금': ('식비', '식자재 구매'),
    '설탕': ('식비', '식자재 구매'),
    '후추': ('식비', '식자재 구매'),
    '마늘': ('식비', '식자재 구매'),
    '양파': ('식비', '식자재 구매'),
    '대파': ('식비', '식자재 구매'),
    '파': ('식비', '식자재 구매'),
    '생강': ('식비', '식자재 구매'),
    '고추': ('식비', '식자재 구매'),
    '당근': ('식비', '식자재 구매'),
    '감자': ('식비', '식자재 구매'),
    '고구마': ('식비', '식자재 구매'),
    '배추': ('식비', '식자재 구매'),
    '무': ('식비', '식자재 구매'),
    '오이': ('식비', '식자재 구매'),
    '토마토': ('식비', '식자재 구매'),
    '시금치': ('식비', '식자재 구매'),
    '상추': ('식비', '식자재 구매'),
    '양배추': ('식비', '식자재 구매'),
    '브로콜리': ('식비', '식자재 구매'),
    '버섯': ('식비', '식자재 구매'),
    '새송이': ('식비', '식자재 구매'),
    '팽이버섯': ('식비', '식자재 구매'),
    '두부': ('식비', '식자재 구매'),
    '콩나물': ('식비', '식자재 구매'),
    '숙주': ('식비', '식자재 구매'),
    '돼지고기': ('식비', '식자재 구매'),
    '삼겹살': ('식비', '식자재 구매'),
    '목살': ('식비', '식자재 구매'),
    '앞다리': ('식비', '식자재 구매'),
    '뒷다리': ('식비', '식자재 구매'),
    '소고기': ('식비', '식자재 구매'),
    '한우': ('식비', '식자재 구매'),
    '등심': ('식비', '식자재 구매'),
    '안심': ('식비', '식자재 구매'),
    '갈비': ('식비', '식자재 구매'),
    '닭고기': ('식비', '식자재 구매'),
    '닭가슴살': ('식비', '식자재 구매'),
    '닭다리': ('식비', '식자재 구매'),
    '닭날개': ('식비', '식자재 구매'),
    '오리고기': ('식비', '식자재 구매'),
    '생선': ('식비', '식자재 구매'),
    '고등어': ('식비', '식자재 구매'),
    '갈치': ('식비', '식자재 구매'),
    '삼치': ('식비', '식자재 구매'),
    '연어': ('식비', '식자재 구매'),
    '참치': ('식비', '식자재 구매'),
    '새우': ('식비', '식자재 구매'),
    '오징어': ('식비', '식자재 구매'),
    '조개': ('식비', '식자재 구매'),
    '굴': ('식비', '식자재 구매'),
    '게': ('식비', '식자재 구매'),
    '멸치': ('식비', '식자재 구매'),
    '김': ('식비', '식자재 구매'),
    '미역': ('식비', '식자재 구매'),
    '다시마': ('식비', '식자재 구매'),
    '사과': ('식비', '식자재 구매'),
    '배': ('식비', '식자재 구매'),
    '귤': ('식비', '식자재 구매'),
    '오렌지': ('식비', '식자재 구매'),
    '바나나': ('식비', '식자재 구매'),
    '포도': ('식비', '식자재 구매'),
    '딸기': ('식비', '식자재 구매'),
    '수박': ('식비', '식자재 구매'),
    '참외': ('식비', '식자재 구매'),
    '멜론': ('식비', '식자재 구매'),
    '복숭아': ('식비', '식자재 구매'),
    '자두': ('식비', '식자재 구매'),
    '키위': ('식비', '식자재 구매'),
    '망고': ('식비', '식자재 구매'),
    '아보카도': ('식비', '식자재 구매'),
    '블루베리': ('식비', '식자재 구매'),
    '체리': ('식비', '식자재 구매'),
    '레몬': ('식비', '식자재 구매'),
    '라임': ('식비', '식자재 구매'),
    '자몽': ('식비', '식자재 구매'),

    // ─────────────────────────────────────────────────────────────
    // 식비 > 간식
    // ─────────────────────────────────────────────────────────────
    '과자': ('식비', '간식'),
    '새우깡': ('식비', '간식'),
    '포카칩': ('식비', '간식'),
    '프링글스': ('식비', '간식'),
    '초코파이': ('식비', '간식'),
    '오레오': ('식비', '간식'),
    '빼빼로': ('식비', '간식'),
    '젤리': ('식비', '간식'),
    '사탕': ('식비', '간식'),
    '껌': ('식비', '간식'),
    '초콜릿': ('식비', '간식'),
    '초콜렛': ('식비', '간식'),
    '아이스크림': ('식비', '간식'),
    '빙과': ('식비', '간식'),
    '팥빙수': ('식비', '간식'),
    '케이크': ('식비', '간식'),
    '빵': ('식비', '간식'),
    '식빵': ('식비', '간식'),
    '크로아상': ('식비', '간식'),
    '도넛': ('식비', '간식'),
    '쿠키': ('식비', '간식'),
    '마카롱': ('식비', '간식'),
    '떡': ('식비', '간식'),
    '약과': ('식비', '간식'),
    '호두과자': ('식비', '간식'),
    '붕어빵': ('식비', '간식'),
    '견과류': ('식비', '간식'),
    '아몬드': ('식비', '간식'),
    '호두': ('식비', '간식'),
    '땅콩': ('식비', '간식'),
    '캐슈넛': ('식비', '간식'),

    // ─────────────────────────────────────────────────────────────
    // 식비 > 음료
    // ─────────────────────────────────────────────────────────────
    '음료': ('식비', '음료'),
    '생수': ('식비', '음료'),
    '물': ('식비', '음료'),
    '탄산수': ('식비', '음료'),
    '콜라': ('식비', '음료'),
    '사이다': ('식비', '음료'),
    '환타': ('식비', '음료'),
    '스프라이트': ('식비', '음료'),
    '주스': ('식비', '음료'),
    '오렌지주스': ('식비', '음료'),
    '사과주스': ('식비', '음료'),
    '포도주스': ('식비', '음료'),
    '커피': ('식비', '음료'),
    '아메리카노': ('식비', '음료'),
    '라떼': ('식비', '음료'),
    '카페라떼': ('식비', '음료'),
    '믹스커피': ('식비', '음료'),
    '캔커피': ('식비', '음료'),
    '녹차': ('식비', '음료'),
    '홍차': ('식비', '음료'),
    '보리차': ('식비', '음료'),
    '옥수수차': ('식비', '음료'),
    '이온음료': ('식비', '음료'),
    '게토레이': ('식비', '음료'),
    '파워에이드': ('식비', '음료'),
    '포카리스웨트': ('식비', '음료'),
    '에너지드링크': ('식비', '음료'),
    '레드불': ('식비', '음료'),
    '핫식스': ('식비', '음료'),
    '맥주': ('식비', '음료'),
    '소주': ('식비', '음료'),
    '막걸리': ('식비', '음료'),
    '와인': ('식비', '음료'),
    '위스키': ('식비', '음료'),
    '사케': ('식비', '음료'),

    // ─────────────────────────────────────────────────────────────
    // 식비 > 가공식품/즉석식품
    // ─────────────────────────────────────────────────────────────
    '라면': ('식비', null),
    '신라면': ('식비', null),
    '진라면': ('식비', null),
    '너구리': ('식비', null),
    '짜파게티': ('식비', null),
    '불닭볶음면': ('식비', null),
    '컵라면': ('식비', null),
    '즉석밥': ('식비', null),
    '햇반': ('식비', null),
    '레토르트': ('식비', null),
    '카레': ('식비', null),
    '짜장': ('식비', null),
    '통조림': ('식비', null),
    '햄': ('식비', null),
    '스팸': ('식비', null),
    '소세지': ('식비', null),
    '비엔나': ('식비', null),
    '냉동식품': ('식비', null),
    '만두': ('식비', null),
    '피자': ('식비', null),
    '치킨너겟': ('식비', null),
    '김밥': ('식비', null),
    '도시락': ('식비', null),
    '샌드위치': ('식비', null),
    '샐러드': ('식비', null),

    // ─────────────────────────────────────────────────────────────
    // 식비 > 외식
    // ─────────────────────────────────────────────────────────────
    '배달': ('식비', '외식'),
    '배민': ('식비', '외식'),
    '요기요': ('식비', '외식'),
    '쿠팡이츠': ('식비', '외식'),
    '치킨': ('식비', '외식'),
    'bbq': ('식비', '외식'),
    'bhc': ('식비', '외식'),
    '굽네': ('식비', '외식'),
    '교촌': ('식비', '외식'),
    '맥도날드': ('식비', '외식'),
    '맥날': ('식비', '외식'),
    '버거킹': ('식비', '외식'),
    '롯데리아': ('식비', '외식'),
    '맘스터치': ('식비', '외식'),
    '스타벅스': ('식비', '외식'),
    '투썸': ('식비', '외식'),
    '이디야': ('식비', '외식'),
    '메가커피': ('식비', '외식'),
    '컴포즈': ('식비', '외식'),
    '파리바게트': ('식비', '외식'),
    '뚜레쥬르': ('식비', '외식'),
    '던킨': ('식비', '외식'),
    '크리스피크림': ('식비', '외식'),
    '서브웨이': ('식비', '외식'),
    '김밥천국': ('식비', '외식'),

    // ─────────────────────────────────────────────────────────────
    // 생활용품비
    // ─────────────────────────────────────────────────────────────
    '휴지': ('생활용품비', null),
    '화장지': ('생활용품비', null),
    '두루마리': ('생활용품비', null),
    '키친타올': ('생활용품비', null),
    '물티슈': ('생활용품비', null),
    '티슈': ('생활용품비', null),
    '세제': ('생활용품비', null),
    '세탁세제': ('생활용품비', null),
    '섬유유연제': ('생활용품비', null),
    '다우니': ('생활용품비', null),
    '주방세제': ('생활용품비', null),
    '퐁퐁': ('생활용품비', null),
    '트리오': ('생활용품비', null),
    '락스': ('생활용품비', null),
    '표백제': ('생활용품비', null),
    '샴푸': ('생활용품비', null),
    '린스': ('생활용품비', null),
    '컨디셔너': ('생활용품비', null),
    '바디워시': ('생활용품비', null),
    '비누': ('생활용품비', null),
    '치약': ('생활용품비', null),
    '칫솔': ('생활용품비', null),
    '구강청결제': ('생활용품비', null),
    '치실': ('생활용품비', null),
    '면도기': ('생활용품비', null),
    '면도날': ('생활용품비', null),
    '면도크림': ('생활용품비', null),
    '로션': ('생활용품비', null),
    '스킨': ('생활용품비', null),
    '선크림': ('생활용품비', null),
    '핸드크림': ('생활용품비', null),
    '립밤': ('생활용품비', null),
    '생리대': ('생활용품비', null),
    '탐폰': ('생활용품비', null),
    '기저귀': ('생활용품비', null),
    '쓰레기봉투': ('생활용품비', null),
    '종량제봉투': ('생활용품비', null),
    '비닐봉투': ('생활용품비', null),
    '지퍼백': ('생활용품비', null),
    '랩': ('생활용품비', null),
    '호일': ('생활용품비', null),
    '수세미': ('생활용품비', null),
    '고무장갑': ('생활용품비', null),
    '빗자루': ('생활용품비', null),
    '걸레': ('생활용품비', null),
    '청소포': ('생활용품비', null),
    '방향제': ('생활용품비', null),
    '탈취제': ('생활용품비', null),
    '살충제': ('생활용품비', null),
    '모기향': ('생활용품비', null),
    '전구': ('생활용품비', null),
    '건전지': ('생활용품비', null),
    '배터리': ('생활용품비', null),
    '멀티탭': ('생활용품비', null),

    // ─────────────────────────────────────────────────────────────
    // 의료/건강비
    // ─────────────────────────────────────────────────────────────
    '약': ('의료/건강비', null),
    '병원': ('의료/건강비', null),
    '진료비': ('의료/건강비', null),
    '약국': ('의료/건강비', null),
    '타이레놀': ('의료/건강비', null),
    '두통약': ('의료/건강비', null),
    '감기약': ('의료/건강비', null),
    '소화제': ('의료/건강비', null),
    '비타민': ('의료/건강비', null),
    '영양제': ('의료/건강비', null),
    '유산균': ('의료/건강비', null),
    '오메가3': ('의료/건강비', null),
    '밴드': ('의료/건강비', null),
    '반창고': ('의료/건강비', null),
    '소독약': ('의료/건강비', null),
    '안약': ('의료/건강비', null),
    '콘택트렌즈': ('의료/건강비', null),
    '렌즈': ('의료/건강비', null),
    '마스크': ('의료/건강비', null),
    '손소독제': ('의료/건강비', null),
    '체온계': ('의료/건강비', null),
    '혈압계': ('의료/건강비', null),

    // ─────────────────────────────────────────────────────────────
    // 교통비
    // ─────────────────────────────────────────────────────────────
    '주유': ('교통비', null),
    '주유소': ('교통비', null),
    '기름값': ('교통비', null),
    '휘발유': ('교통비', null),
    '경유': ('교통비', null),
    'lpg': ('교통비', null),
    '충전': ('교통비', null),
    '전기차충전': ('교통비', null),
    '하이패스': ('교통비', null),
    '통행료': ('교통비', null),
    '톨게이트': ('교통비', null),
    '주차': ('교통비', null),
    '주차비': ('교통비', null),
    '주차요금': ('교통비', null),
    '발렛': ('교통비', null),
    '버스': ('교통비', null),
    '지하철': ('교통비', null),
    '택시': ('교통비', null),
    '카카오택시': ('교통비', null),
    'ktx': ('교통비', null),
    '기차': ('교통비', null),
    '무궁화': ('교통비', null),
    '새마을': ('교통비', null),
    '고속버스': ('교통비', null),
    '시외버스': ('교통비', null),
    '비행기': ('교통비', null),
    '항공': ('교통비', null),
    '렌터카': ('교통비', null),
    '킥보드': ('교통비', null),
    '따릉이': ('교통비', null),
    '자전거': ('교통비', null),

    // ─────────────────────────────────────────────────────────────
    // 통신비
    // ─────────────────────────────────────────────────────────────
    '휴대폰': ('통신비', null),
    '핸드폰': ('통신비', null),
    '통신비': ('통신비', null),
    '요금제': ('통신비', null),
    'skt': ('통신비', null),
    'kt': ('통신비', null),
    'lgu': ('통신비', null),
    '알뜰폰': ('통신비', null),
    '인터넷': ('통신비', null),
    'iptv': ('통신비', null),
    '케이블': ('통신비', null),

    // ─────────────────────────────────────────────────────────────
    // 의류/잡화
    // ─────────────────────────────────────────────────────────────
    '옷': ('의류/잡화', null),
    '의류': ('의류/잡화', null),
    '티셔츠': ('의류/잡화', null),
    '셔츠': ('의류/잡화', null),
    '바지': ('의류/잡화', null),
    '청바지': ('의류/잡화', null),
    '치마': ('의류/잡화', null),
    '원피스': ('의류/잡화', null),
    '자켓': ('의류/잡화', null),
    '코트': ('의류/잡화', null),
    '패딩': ('의류/잡화', null),
    '점퍼': ('의류/잡화', null),
    '니트': ('의류/잡화', null),
    '가디건': ('의류/잡화', null),
    '양말': ('의류/잡화', null),
    '속옷': ('의류/잡화', null),
    '팬티': ('의류/잡화', null),
    '브라': ('의류/잡화', null),
    '신발': ('의류/잡화', null),
    '운동화': ('의류/잡화', null),
    '구두': ('의류/잡화', null),
    '슬리퍼': ('의류/잡화', null),
    '샌들': ('의류/잡화', null),
    '부츠': ('의류/잡화', null),
    '가방': ('의류/잡화', null),
    '백팩': ('의류/잡화', null),
    '지갑': ('의류/잡화', null),
    '벨트': ('의류/잡화', null),
    '모자': ('의류/잡화', null),
    '장갑': ('의류/잡화', null),
    '목도리': ('의류/잡화', null),
    '머플러': ('의류/잡화', null),
    '안경': ('의류/잡화', null),
    '선글라스': ('의류/잡화', null),
    '시계': ('의류/잡화', null),
    '반지': ('의류/잡화', null),
    '목걸이': ('의류/잡화', null),
    '귀걸이': ('의류/잡화', null),
    '팔찌': ('의류/잡화', null),
    '유니클로': ('의류/잡화', null),
    '자라': ('의류/잡화', null),
    'h&m': ('의류/잡화', null),
    '나이키': ('의류/잡화', null),
    '아디다스': ('의류/잡화', null),
    '뉴발란스': ('의류/잡화', null),

    // ─────────────────────────────────────────────────────────────
    // 문화/여가비
    // ─────────────────────────────────────────────────────────────
    '영화': ('문화/여가비', null),
    'cgv': ('문화/여가비', null),
    '메가박스': ('문화/여가비', null),
    '롯데시네마': ('문화/여가비', null),
    '팝콘': ('문화/여가비', null),
    '공연': ('문화/여가비', null),
    '콘서트': ('문화/여가비', null),
    '뮤지컬': ('문화/여가비', null),
    '연극': ('문화/여가비', null),
    '전시': ('문화/여가비', null),
    '박물관': ('문화/여가비', null),
    '미술관': ('문화/여가비', null),
    '놀이공원': ('문화/여가비', null),
    '에버랜드': ('문화/여가비', null),
    '롯데월드': ('문화/여가비', null),
    '워터파크': ('문화/여가비', null),
    '캠핑': ('문화/여가비', null),
    '펜션': ('문화/여가비', null),
    '호텔': ('문화/여가비', null),
    '여행': ('문화/여가비', null),
    '항공권': ('문화/여가비', null),
    '숙박': ('문화/여가비', null),
    '에어비앤비': ('문화/여가비', null),
    '야놀자': ('문화/여가비', null),
    '여기어때': ('문화/여가비', null),
    '헬스': ('문화/여가비', null),
    '헬스장': ('문화/여가비', null),
    '피트니스': ('문화/여가비', null),
    '수영': ('문화/여가비', null),
    '수영장': ('문화/여가비', null),
    '요가': ('문화/여가비', null),
    '필라테스': ('문화/여가비', null),
    '골프': ('문화/여가비', null),
    '스크린골프': ('문화/여가비', null),
    '볼링': ('문화/여가비', null),
    '당구': ('문화/여가비', null),
    '노래방': ('문화/여가비', null),
    'pc방': ('문화/여가비', null),
    '게임': ('문화/여가비', null),
    '넷플릭스': ('문화/여가비', null),
    '유튜브프리미엄': ('문화/여가비', null),
    '멜론구독': ('문화/여가비', null),
    '스포티파이': ('문화/여가비', null),
    '책': ('문화/여가비', null),
    '도서': ('문화/여가비', null),
    '교보문고': ('문화/여가비', null),
    '예스24': ('문화/여가비', null),
    '알라딘': ('문화/여가비', null),

    // ─────────────────────────────────────────────────────────────
    // 교육비
    // ─────────────────────────────────────────────────────────────
    '학원': ('교육비', null),
    '학원비': ('교육비', null),
    '수강료': ('교육비', null),
    '과외': ('교육비', null),
    '과외비': ('교육비', null),
    '학습지': ('교육비', null),
    '인강': ('교육비', null),
    '온라인강의': ('교육비', null),
    '등록금': ('교육비', null),
    '교재': ('교육비', null),
    '교재비': ('교육비', null),
    '문구': ('교육비', null),
    '필기구': ('교육비', null),
    '펜': ('교육비', null),
    '볼펜': ('교육비', null),
    '연필': ('교육비', null),
    '노트': ('교육비', null),
    '공책': ('교육비', null),

    // ─────────────────────────────────────────────────────────────
    // 경조사비
    // ─────────────────────────────────────────────────────────────
    '축의금': ('경조사비', null),
    '부의금': ('경조사비', null),
    '조의금': ('경조사비', null),
    '결혼': ('경조사비', null),
    '장례': ('경조사비', null),
    '돌잔치': ('경조사비', null),
    '생일선물': ('경조사비', null),
    '선물': ('경조사비', null),
    '기프트': ('경조사비', null),
    '기프티콘': ('경조사비', null),
    '상품권': ('경조사비', null),
    '백화점상품권': ('경조사비', null),
    '문화상품권': ('경조사비', null),

    // ─────────────────────────────────────────────────────────────
    // 주거비
    // ─────────────────────────────────────────────────────────────
    '월세': ('주거비', null),
    '전세': ('주거비', null),
    '관리비': ('주거비', null),
    '아파트관리비': ('주거비', null),
    '전기세': ('주거비', null),
    '전기요금': ('주거비', null),
    '가스비': ('주거비', null),
    '가스요금': ('주거비', null),
    '수도세': ('주거비', null),
    '수도요금': ('주거비', null),
    '난방비': ('주거비', null),
    '보일러': ('주거비', null),
    '수리비': ('주거비', null),
    '인테리어': ('주거비', null),
    '이사': ('주거비', null),
    '이사비': ('주거비', null),
    '부동산': ('주거비', null),
    '중개수수료': ('주거비', null),

    // ─────────────────────────────────────────────────────────────
    // 보험료
    // ─────────────────────────────────────────────────────────────
    '보험': ('보험료', null),
    '보험료': ('보험료', null),
    '실비보험': ('보험료', null),
    '생명보험': ('보험료', null),
    '자동차보험': ('보험료', null),
    '화재보험': ('보험료', null),
    '여행자보험': ('보험료', null),

    // ─────────────────────────────────────────────────────────────
    // 기타/잡비
    // ─────────────────────────────────────────────────────────────
    '수수료': ('기타/잡비', null),
    '배송비': ('기타/잡비', null),
    '택배비': ('기타/잡비', null),
    '세금': ('기타/잡비', null),
    '벌금': ('기타/잡비', null),
    '과태료': ('기타/잡비', null),
    '인지세': ('기타/잡비', null),
    '복사': ('기타/잡비', null),
    '인쇄': ('기타/잡비', null),
    '프린트': ('기타/잡비', null),
  };

  /// Fuzzy matching threshold: 0.0 (exact) to 1.0 (very loose).
  static const double _fuzzyThreshold = 0.25;

  /// Normalize input for matching.
  String _normalize(String raw) {
    var s = raw.trim().toLowerCase();
    if (s.isEmpty) return '';

    // Remove promo patterns
    s = s.replaceAll(RegExp(r'\d+\s*[+×x]\s*\d+'), ' ');
    s = s.replaceAll(RegExp(r'\s+'), '');
    s = s.replaceAll(RegExp(r'[^a-z0-9가-힣]'), '');

    // Remove trailing units
    s = s.replaceAll(
      RegExp(
        r'(\d+(?:\.\d+)?)(ml|l|kg|g|mg|개|입|팩|봉|병|캔|장|p|pcs|pc|box)$',
      ),
      '',
    );

    // Remove promo suffixes
    s = s.replaceAll(RegExp(r'(행사|증정|무료|덤|할인|특가|세일)$'), '');

    return s;
  }

  /// Simple Levenshtein-based similarity (0.0 to 1.0).
  double _similarity(String a, String b) {
    if (a == b) return 1.0;
    if (a.isEmpty || b.isEmpty) return 0.0;

    final len = a.length > b.length ? a.length : b.length;
    final dist = _levenshtein(a, b);
    return 1.0 - (dist / len);
  }

  int _levenshtein(String s, String t) {
    if (s == t) return 0;
    if (s.isEmpty) return t.length;
    if (t.isEmpty) return s.length;

    final sLen = s.length;
    final tLen = t.length;
    var prev = List<int>.generate(tLen + 1, (i) => i);
    var curr = List<int>.filled(tLen + 1, 0);

    for (var i = 1; i <= sLen; i++) {
      curr[0] = i;
      for (var j = 1; j <= tLen; j++) {
        final cost = s[i - 1] == t[j - 1] ? 0 : 1;
        curr[j] = [
          prev[j] + 1, // deletion
          curr[j - 1] + 1, // insertion
          prev[j - 1] + cost, // substitution
        ].reduce((a, b) => a < b ? a : b);
      }
      final tmp = prev;
      prev = curr;
      curr = tmp;
    }
    return prev[tLen];
  }

  /// Classify a product description.
  ///
  /// Returns (mainCategory, subCategory?) or null if no match.
  (String, String?)? classify(String description) {
    final normalized = _normalize(description);
    if (normalized.isEmpty) return null;

    // 1. Exact keyword match
    final exact = _keywordToCategory[normalized];
    if (exact != null) return exact;

    // 2. Substring/contains match (keyword in description)
    (String, String?)? bestContains;
    var bestContainsLen = 0;
    for (final entry in _keywordToCategory.entries) {
      final kw = entry.key;
      if (kw.length <= bestContainsLen) continue;
      if (normalized.contains(kw)) {
        bestContains = entry.value;
        bestContainsLen = kw.length;
      }
    }
    if (bestContains != null) return bestContains;

    // 3. Fuzzy match (for typos)
    (String, String?)? bestFuzzy;
    var bestFuzzyScore = 0.0;
    for (final entry in _keywordToCategory.entries) {
      final kw = entry.key;
      // Only fuzzy-match if lengths are somewhat similar
      if ((normalized.length - kw.length).abs() > 3) continue;
      final score = _similarity(normalized, kw);
      if (score > _fuzzyThreshold && score > bestFuzzyScore) {
        bestFuzzy = entry.value;
        bestFuzzyScore = score;
      }
    }
    if (bestFuzzy != null) return bestFuzzy;

    return null;
  }

  /// Check if a main category is valid in the given category options.
  bool isValidMainCategory(
    String main,
    Map<String, List<String>> categoryOptions,
  ) {
    return categoryOptions.containsKey(main);
  }

  /// Check if a sub category is valid for the given main category.
  bool isValidSubCategory(
    String main,
    String? sub,
    Map<String, List<String>> categoryOptions,
  ) {
    if (sub == null || sub.isEmpty) return true;
    final subs = categoryOptions[main];
    if (subs == null) return false;
    return subs.contains(sub);
  }
}
